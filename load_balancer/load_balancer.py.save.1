import math
import matplotlib.pyplot as plt

TOTAL_SLOTS = 512
VIRTUAL_SERVERS_PER_SERVER = 9

class ConsistentHashMap:
    def __init__(self):
        self.hash_ring = [None] * TOTAL_SLOTS  # Initialize empty ring
        self.server_slots = {}  # Map server_id -> list of occupied slots
        self.request_counts = {}
    def hash_request(self, i):
        return (i ** 2 + 2 * i + 17) % TOTAL_SLOTS

    def hash_virtual_server(self, server_id, replica_id):
        return (server_id ** 2 + replica_id + 2 * replica_id + 25) % TOTAL_SLOTS

    def add_server(self, server_id):
        print(f"Adding server {server_id}...")
        self.server_slots[server_id] = []
        for replica_id in range(VIRTUAL_SERVERS_PER_SERVER):
            slot = self.hash_virtual_server(server_id, replica_id)
            slot = self._find_free_slot(slot)
            self.hash_ring[slot] = (server_id, replica_id)
            self.server_slots[server_id].append(slot)
        print(f"Server {server_id} added with slots: {self.server_slots[server_id]}")

    def remove_server(self, server_id):
        print(f"Removing server {server_id}...")
        if server_id in self.server_slots:
            for slot in self.server_slots[server_id]:
                self.hash_ring[slot] = None
            del self.server_slots[server_id]
            print(f"Server {server_id} removed.")

    def route_request(self, request_id):
        request_slot = self.hash_request(request_id)
        slot = request_slot
        while self.hash_ring[slot] is None:
            slot = (slot + 1) % TOTAL_SLOTS  # Linear probing
            if slot == request_slot:
                print("Error: No servers available!")
                return None
        server_id, replica_id = self.hash_ring[slot]
        if server_id in self.request_counts:
            self.request_counts[server_id] += 1
        else:
            self.request_counts[server_id] = 1
        print(f"Request {request_id} routed to Server {server_id} (Replica {replica_id})")
        return server_id

    def _find_free_slot(self, start_slot):
        slot = start_slot
        while self.hash_ring[slot] is not None:
            slot = (slot + 1) % TOTAL_SLOTS  # Linear probing
        return slot

    def plot_server_load(self):
        if not self.request_counts:
            print("No requests have been routed yet.")
            return

        server_ids = list(self.request_counts.keys())
        request_counts = list(self.request_counts.values())

        plt.bar(server_ids, request_counts, color='skyblue')
        plt.xlabel('Server ID')
        plt.ylabel('Number of Requests')
        plt.title('Server Load Distribution')
        plt.xticks(server_ids)
        plt.tight_layout()
        plt.savefig("server_load_distribution.png")
        print(" Graph saved as 'server_load_distribution.png'")


